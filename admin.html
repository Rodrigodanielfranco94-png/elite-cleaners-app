<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite Admin</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
</head>
<body class="admin-body">
    <div class="admin-container">
        <h1 class="logo-text">ELITE <span>ADMIN</span></h1>
        <button onclick="logout()" class="logout-link">CERRAR SESIÓN</button>

        <div class="card">
            <h2 class="section-title">ASIGNAR SERVICIO</h2>
            
            <input type="text" id="cliente" placeholder="Nombre del Cliente" class="input-field">
            <input type="text" id="direccion" placeholder="Dirección del Servicio" class="input-field">
            
            <input type="text" id="empleado-nombre" placeholder="Nombre del Empleado" class="input-field">
            <input type="email" id="staff-email" placeholder="Gmail del Empleado" class="input-field">
            
            <div class="row">
                <input type="date" id="fecha" class="input-field half">
                <input type="time" id="hora" class="input-field half">
            </div>

            <textarea id="notas" placeholder="Descripción del trabajo..." class="input-field textarea"></textarea>

            <p class="type-label">TIPO DE LIMPIEZA:</p>
            <div class="type-grid">
                <button id="btn-estandar" class="type-btn active" onclick="setType('Estándar')">ESTÁNDAR</button>
                <button id="btn-profunda" class="type-btn" onclick="setType('Profunda')">PROFUNDA</button>
                <button id="btn-movein" class="type-btn" onclick="setType('Move-in')">MOVE-IN</button>
                <button id="btn-moveout" class="type-btn" onclick="setType('Move-out')">MOVE-OUT</button>
            </div>

            <button id="main-send-btn" onclick="saveJob()" class="send-btn">GUARDAR Y NOTIFICAR POR EMAIL</button>
        </div>

        <div class="search-section">
            <p class="search-label">BUSCADOR DE EMPLEADO / CLIENTE</p>
            <input type="text" id="search-input" placeholder="Escribe el nombre o email..." onkeyup="searchJobs()" class="search-input">
            <div id="jobs-container"></div>
        </div>
    </div>

    <script>
        // CONFIGURACIÓN FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyC2...", 
            authDomain: "elite-cleaners-company.firebaseapp.com",
            databaseURL: "https://elite-cleaners-company-default-rtdb.firebaseio.com",
            projectId: "elite-cleaners-company",
            storageBucket: "elite-cleaners-company.appspot.com",
            messagingSenderId: "331885542036",
            appId: "1:331885542036:web:46244dfb841793666d66e7"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        // CONFIGURACIÓN EMAILJS
        emailjs.init("HND0NNg6H-dBCZtNq"); 

        let selectedType = "Estándar";

        function setType(type) {
            selectedType = type;
            // Desactiva todos
            document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('active'));
            // Activa el seleccionado
            const idMap = {'Estándar': 'btn-estandar', 'Profunda': 'btn-profunda', 'Move-in': 'btn-movein', 'Move-out': 'btn-moveout'};
            document.getElementById(idMap[type]).classList.add('active');
        }

        auth.onAuthStateChanged(user => {
            if (!user) window.location.href = "index.html";
        });

        function saveJob() {
            const btn = document.getElementById('main-send-btn');
            const cliente = document.getElementById('cliente').value;
            const direccion = document.getElementById('direccion').value;
            const empleado = document.getElementById('empleado-nombre').value;
            const email = document.getElementById('staff-email').value;
            const fecha = document.getElementById('fecha').value;
            const hora = document.getElementById('hora').value;
            const notas = document.getElementById('notas').value;

            if(!cliente || !email || !fecha) {
                alert("Por favor completa los campos obligatorios");
                return;
            }

            btn.innerText = "ENVIANDO...";
            btn.disabled = true;

            const jobData = {
                cliente, direccion, empleado, email, fecha, hora, notas,
                tipo: selectedType,
                timestamp: Date.now()
            };

            // Guardar en Firebase y enviar por Gmail
            db.ref('jobs').push(jobData).then(() => {
                emailjs.send("service_8kakktm", "template_r1nt4zb", {
                    to_email: email,
                    client_name: cliente,
                    staff_name: empleado,
                    address: direccion,
                    date_time: fecha + " @ " + hora,
                    type: selectedType,
                    notes: notas
                }).then(() => {
                    alert("¡Servicio guardado y email enviado!");
                    location.reload();
                });
            }).catch(err => {
                alert("Error: " + err.message);
                btn.innerText = "GUARDAR Y NOTIFICAR POR EMAIL";
                btn.disabled = false;
            });
        }

        function searchJobs() {
            const term = document.getElementById('search-input').value.toLowerCase();
            const container = document.getElementById('jobs-container');
            db.ref('jobs').limitToLast(15).once('value', snap => {
                container.innerHTML = "";
                snap.forEach(child => {
                    const j = child.val();
                    if(j.cliente.toLowerCase().includes(term) || j.empleado?.toLowerCase().includes(term)) {
                        container.innerHTML += `
                            <div class="job-item">
                                <p><strong>${j.cliente}</strong> - ${j.tipo}</p>
                                <p>Empleado: ${j.empleado || '---'}</p>
                                <p>${j.fecha} | ${j.hora}</p>
                            </div>`;
                    }
                });
            });
        }

        function logout() { auth.signOut(); }
        searchJobs();
    </script>
</body>
</html>
